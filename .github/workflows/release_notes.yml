name: Generate Release Notes

on:
  push:
    tags:
      - 'v*' # Trigger the workflow on tag creation
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to compare and generate release notes'
        required: false

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16

      - name: Install dependencies
        run: npm install

      - name: Determine Tag
        id: tag
        run: |
          echo "TAG=${{ github.event.inputs.tag || github.ref }}" >> $GITHUB_ENV

      - name: Generate Release Notes
        id: release-notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tag_to_compare=${{ process.env.TAG }}

          # Fetch the pull requests associated with the specified tag
          pull_requests=$(gh pr list --state merged --base main --head "refs/tags/$tag_to_compare" --json number,title,url --jq '.[] | "\(.number) \(.title) \(.html_url)"')

          # Initialize the release notes string
          release_notes=""

          # Iterate through the pull requests
          while read -r pull_request; do
            pr_number=$(echo "$pull_request" | awk '{print $1}')
            pr_title=$(echo "$pull_request" | awk '{print $2}')
            pr_url=$(echo "$pull_request" | awk '{print $3}')

            # Extract issue references from the pull request body
            issue_references=$(gh pr view "$pr_number" --json 'body' | jq -r '.body' | grep -E -o 'Fixes|Closes|Resolves #[0-9]+')

            # Iterate through the issue references
            while read -r issue_reference; do
              issue_number=$(echo "$issue_reference" | grep -E -o '[0-9]+')

              # Create the issue link
              issue_link="https://github.com/${{ github.repository }}/issues/${issue_number}"

              # Generate the release note line with the pull request and issue links
              release_note="- [PR #$pr_number]($pr_url): $pr_title ([Issue #$issue_number]($issue_link))"

              # Append the release note to the release notes string
              release_notes="$release_notes\n$release_note"
            done <<< "$issue_references"
          done <<< "$pull_requests"

          # Write the release notes to an environment file
          echo "RELEASE_NOTES=$release_notes" >> $GITHUB_ENV

      - name: Create or Update Release
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const notes = `Release Notes:${process.env.RELEASE_NOTES}`;
            const tagName = context.ref.replace('refs/tags/', '');
            const release = context.payload.release;
            if (release) {
              github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                tag_name: tagName,
                body: notes
              });
            } else {
              github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: tagName,
                body: notes,
                draft: false,
                prerelease: false
              });
            }
